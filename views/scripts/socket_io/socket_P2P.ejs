<script>
document.addEventListener('DOMContentLoaded', () => {
    
const socket_Vid = io('/videoStream');
console.log('Connected to channel_1 view');

socket_Vid.on('connect', () => {
  console.log('SOCKET_P2P.EJS client connected');
});

socket_Vid.on('connect_error', (err) => {
  console.error('Connection error:', err);
});

// socket_Vid.on('broadcast',(videoUrl)=>{
//   const finUrl = videoUrl.videoUrl.videoUrl
//   console.log(`CHANNEL ONE BROADCAST NOTICED url:${finUrl}`)

// })

socket_Vid.on('marquee', (data) => {
  console.log('Received marquee message:', data.message);
  const marqueeText = document.getElementById('marqueeText');
  marqueeText.innerText = data.message;
  marqueeText.style.display = 'block'; // Show the marquee
});

document.addEventListener('click', (event) => {
  if(event.target.classList.contains('play-video')){
    const videoUrl=event.target.getAttribute('data-video')
    console.log(`playVIDDDSS!! ${videoUrl}`)
    socket_Vid.emit('broadcast',{videoUrl:videoUrl})
  }
});

document.addEventListener('click', (event) => {
  if (event.target.classList.contains('marqueeButton')) {
    const marqueeMessage = document.getElementById('marqueeMessage').value;
    console.log('Button clicked', marqueeMessage);
    socket_Vid.emit('marquee', { message: marqueeMessage });
    console.log('Marquee event emitted');

  
  }
});



console.log(`connected to socket_P2P view`)
  let localStream;
  let peers = {};
  async function getMedia() {
    try {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false});
      const videoElement = document.getElementById('myVideo');
      videoElement.srcObject = localStream;
    } catch (err) {
      console.error(err);
    }
  }
  function startCamera() {
    getMedia();
    showNextCard();
  }

  function stopCamera() {
    const tracks = localStream.getTracks();
    tracks.forEach(track => track.stop());
    localStream = null;
    document.getElementById('myVideo').srcObject = null;
    showNextCard();
  }

  function showNextCard() {
    const currentCard = document.querySelector('.index-card.active');
    const nextCard = currentCard.nextElementSibling;
    if (nextCard && nextCard.classList.contains('index-card')) {
      currentCard.classList.remove('active');
      nextCard.classList.add('active');
    }
  }

  function showPreviousCard() {
    const currentCard = document.querySelector('.index-card.active');
    const previousCard = currentCard.previousElementSibling;
    if (previousCard && previousCard.classList.contains('index-card')) {
      currentCard.classList.remove('active');
      previousCard.classList.add('active');
    }
  }

  async function createRoom() {
    const roomName = document.getElementById('roomName').value;
    try {
      const response = await fetch('/videoStream/createRoom', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ roomName })
      });
      const data = await response.json();
      console.log(`Room created with ID: ${data.roomId}`);
    } catch (error) {
      console.error('Failed to create room', error);
    }
  }

  function joinRoom(roomId) {
    socket_Vid.emit('joinRoom', roomId);
    showNextCard();
  }

  async function deleteRoom(roomId) {
    try {
      const response = await fetch('/videoStream/deleteRoom', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ roomId })
      });
      const data = await response.json();
      if (data.success) {
        console.log(`Room deleted: ${roomId}`);
        document.querySelector(`button[onclick="joinRoom('${roomId}')"]`).parentElement.remove();
      }
    } catch (error) {
      console.error('Failed to delete room', error);
    }
  }

  function setupPeerConnection(peerId) {
    const peerConnection = new RTCPeerConnection({
      iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
    });

    peers[peerId] = peerConnection;

    localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

    peerConnection.onicecandidate = event => {
      if (event.candidate) {
        socket_Vid.emit('p2pCandidate', {
          peerId: peerId,
          candidate: event.candidate
        });
      }
    };

    peerConnection.ontrack = event => {
      const videoElement = document.createElement('video');
      videoElement.srcObject = event.streams[0];
      videoElement.autoplay = true;
      videoElement.className = "peer";
      document.querySelector('.peers').appendChild(videoElement);
    };

    return peerConnection;
  }

  function startCall(peerId) {
    const peerConnection = setupPeerConnection(peerId);

    peerConnection.createOffer()
      .then(offer => peerConnection.setLocalDescription(offer))
      .then(() => {
        socket_Vid.emit('p2pInit', {
          peerId: peerId,
          offer: peerConnection.localDescription
        });
      });
  }

  socket_Vid.on('p2pOffer', async (data) => {
    const peerConnection = setupPeerConnection(data.from);

    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
    const answer = await peerConnection.createAnswer();
    await peerConnection.setLocalDescription(answer);
    socket_Vid.emit('p2pAnswer', {
      peerId: data.from,
      answer: peerConnection.localDescription
    });
  });

  socket_Vid.on('p2pAnswer', async (data) => {
    const peerConnection = peers[data.from];
    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
  });

  socket_Vid.on('p2pCandidate', async (data) => {
    const peerConnection = peers[data.from];
    await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
  });

  socket_Vid.on('updateRooms', (rooms) => {
    const roomsList = document.querySelector('.p2pRoomsList');
    roomsList.innerHTML = '';
    rooms.forEach(room => {
      const roomElement = document.createElement('div');
      roomElement.classList.add('room');
      roomElement.innerHTML = `
        <span>${room.name || room.id}</span>
        <span>Guests: ${room.guests}</span>
        <button onclick="joinRoom('${room.id}')">Join</button>
        <button onclick="deleteRoom('${room.id}')">Delete</button>
      `;
      roomsList.appendChild(roomElement);
    });
  });

  socket_Vid.on('roomState', (room) => {
    if (room.offer && !peers[room._id]) {
      startCall(room._id);
    }
    if (room.answer) {
      const peerConnection = peers[room._id];
      peerConnection.setRemoteDescription(new RTCSessionDescription(room.answer));
    }
    room.candidates.forEach(candidate => {
      const peerConnection = peers[room._id];
      peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
    });
  });

  socket_Vid.on('userJoined', (data) => {
    startCall(data.userId);
  });

  // Handle marquee updates
  socket_Vid.on('marquee', (message) => {
    const marqueeText = document.getElementById('marquee-text');
    marqueeText.innerHTML += ` ${message} `;
  });






});
   
function playVideo(url) {
      var videoPlayer = document.getElementById('videoPlayer');
      videoPlayer.src = url;
      videoPlayer.play();
    }
</script>